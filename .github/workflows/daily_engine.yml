name: ü§ñ Daily Content Engine

on:
  # Harici servisler i√ßin (cron-job.org vb.)
  repository_dispatch:
    types: [trigger-content-engine]
  
  # Manuel tetikleme
  workflow_dispatch:
    inputs:
      skip_discovery:
        description: 'Skip discovery phase (use existing queue)'
        required: false
        default: 'false'
        type: boolean
      process_count:
        description: 'Number of repos to process from queue'
        required: false
        default: '1'
        type: string

# Permissions needed for pushing to repo
permissions:
  contents: write

jobs:
  content-engine:
    name: üöÄ Run Content Pipeline
    runs-on: ubuntu-latest
    
    steps:
      # ============================================
      # SETUP
      # ============================================
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üìÅ Ensure Directory Structure
        run: |
          mkdir -p docs/assets/images
          mkdir -p docs/_posts
          touch queue.txt
          touch history.txt
      
      # ============================================
      # DISCOVERY PHASE
      # ============================================
      - name: üîç Run Discovery
        if: ${{ github.event.inputs.skip_discovery != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "üîç Starting repository discovery..."
          python discovery.py
          echo ""
          echo "üìã Current queue:"
          cat queue.txt || echo "(empty)"
      
      # ============================================
      # POSTING PHASE
      # ============================================
      - name: üì§ Run AutoPoster
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
        run: |
          PROCESS_COUNT=${{ github.event.inputs.process_count || '1' }}
          echo "üì§ Processing $PROCESS_COUNT item(s) from queue..."
          
          for i in $(seq 1 $PROCESS_COUNT); do
            echo ""
            echo "=== Processing item $i of $PROCESS_COUNT ==="
            python autoposter.py || echo "‚ö†Ô∏è  Item $i failed or queue empty"
          done
          
          echo ""
          echo "üìã Remaining queue:"
          cat queue.txt || echo "(empty)"
      
      # ============================================
      # GIT COMMIT & PUSH
      # ============================================
      - name: üîß Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Turkish Repo Showcase Bot"
      
      - name: üìä Check for Changes
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected"
            git status --short
          fi
      
      - name: üíæ Commit and Push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          TIMESTAMP=$(TZ='Europe/Istanbul' date '+%Y-%m-%d %H:%M')
          
          NEW_POSTS=$(git diff --staged --name-only | grep '_posts/' | wc -l || echo "0")
          NEW_IMAGES=$(git diff --staged --name-only | grep 'assets/images/' | wc -l || echo "0")
          
          COMMIT_MSG="ü§ñ Auto-update: ${TIMESTAMP} Istanbul time"
          if [ "$NEW_POSTS" -gt 0 ]; then
            COMMIT_MSG="$COMMIT_MSG | +${NEW_POSTS} post(s)"
          fi
          if [ "$NEW_IMAGES" -gt 0 ]; then
            COMMIT_MSG="$COMMIT_MSG | +${NEW_IMAGES} image(s)"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "‚úÖ Changes pushed to repository"
      
      # ============================================
      # SUMMARY
      # ============================================
      - name: üìà Pipeline Summary
        run: |
          echo "============================================"
          echo "üèÅ PIPELINE SUMMARY"
          echo "============================================"
          echo ""
          echo "üìã Queue status:"
          QUEUE_COUNT=$(wc -l < queue.txt 2>/dev/null | tr -d ' ' || echo "0")
          echo "   Items remaining: $QUEUE_COUNT"
          echo ""
          echo "üìö History:"
          HISTORY_COUNT=$(wc -l < history.txt 2>/dev/null | tr -d ' ' || echo "0")
          echo "   Total processed: $HISTORY_COUNT"
          echo ""
          echo "üìù Recent posts:"
          ls -la docs/_posts/ 2>/dev/null | tail -5 || echo "   No posts yet"
          echo ""
          echo "‚úÖ Pipeline complete!"
